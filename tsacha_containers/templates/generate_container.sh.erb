#!/bin/bash

name=$1
domain=$2
hostname=$1.$2
ip=$3
netmask=$4
gateway=$5
resolv=$6
puppet=$7
mac=$(echo $ip | sed -E 's/^[0-9]{1,3}\.[0-9]{1,3}\.([0-9]{1,2})\.([0-9]{1,2})/52:54:00:00:0\1:0\2/g' | sed -E 's/:0([0-9]{2})/:\1/g')
pass="changeme"

if [ ! -f /srv/wheezy.tar ]; then
    cd /srv
    debootstrap --verbose --variant=minbase --include \
	ifupdown,iputils-ping,locales,libui-dialog-perl,dialog,dhcpcd,netbase,net-tools,iproute,openssh-server,apt-utils,vim,emacs23-nox,ruby,wget,curl,aptitude,git \
	--arch amd64 wheezy tmprootfs http://ftp.fr.debian.org/debian
    cd tmprootfs
    tar cvf wheezy.tar --exclude 'wheezy.tar' .
    cd ..
    mv tmprootfs/wheezy.tar .
    rm -Rf tmprootfs/
fi

cd /var/lib/lxc/
mkdir $name && cd $name
mkdir rootfs && cd rootfs
tar xvf /srv/wheezy.tar
cd ..

sed -i 's/[2-6]:23/#&/g' rootfs/etc/inittab
sed -i 's/pf/#&/g' rootfs/etc/inittab
sed -i 's/pn/#&/g' rootfs/etc/inittab
sed -i 's/po/#&/g' rootfs/etc/inittab

sed -i 's/# en_US.UTF-8 UTF-8/en_US.UTF-8 UTF-8/g' rootfs/etc/locale.gen

chroot rootfs /usr/sbin/locale-gen en_US.UTF-8

cat > rootfs/etc/hostname <<EOF
$hostname
EOF

cat > rootfs/etc/network/interfaces <<EOF
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address $ip
netmask $netmask
gateway $gateway
EOF

cat > rootfs/etc/resolv.conf <<EOF
nameserver $resolv
nameserver 8.8.8.8
EOF

cat > rootfs/etc/hosts <<EOF
127.0.0.1       localhost
$ip             $hostname
::1             localhost ip6-localhost ip6-loopback
fe00::0         ip6-localnet
ff00::0         ip6-mcastprefix
ff02::1         ip6-allnodes
ff02::2         ip6-allrouters
EOF

chroot rootfs /usr/sbin/update-rc.d -f umountfs remove
chroot rootfs /usr/sbin/update-rc.d -f hwclock.sh remove
chroot rootfs /usr/sbin/update-rc.d -f hwclockfirst.sh remove

mkdir rootfs/root/.ssh 2> /dev/null
chroot rootfs usermod -p $(echo $pass | openssl passwd -1 -stdin) root

rm rootfs/etc/apt/sources.list.d/puppetlabs.list 2> /dev/null
cat >> rootfs/etc/apt/sources.list.d/puppetlabs.list<<EOF
# puppetlabs
deb  http://apt.puppetlabs.com wheezy main
deb-src  http://apt.puppetlabs.com wheezy main
EOF

rm rootfs/etc/apt/sources.list.d/puppetlabs-dep.list 2> /dev/null
cat >> rootfs/etc/apt/sources.list.d/puppetlabs-dep.list<<EOF
# puppetlabs-dep
deb  http://apt.puppetlabs.com wheezy dependencies
deb-src  http://apt.puppetlabs.com wheezy dependencies
EOF

chroot rootfs wget http://apt.puppetlabs.com/pubkey.gpg
chroot rootfs apt-key add pubkey.gpg
chroot rootfs rm pubkey.gpg

chroot rootfs apt-get update
chroot rootfs apt-get install -y puppet

cp rootfs/etc/puppet/puppet.conf rootfs/etc/puppet/puppet.conf.old
sed "s/\[master\]/server=$puppet\ncertname=$hostname\n\n[master]/g" rootfs/etc/puppet/puppet.conf.old > rootfs/etc/puppet/puppet.conf
cp rootfs/etc/default/puppet rootfs/etc/default/puppet.old
sed 's/START=no/START=yes/g' rootfs/etc/default/puppet.old > rootfs/etc/default/puppet


# Libvirt import 

ram=$(free | head -n 2 | tail -n 1 | awk '{ print $2 }')

cat > /var/lib/lxc/$name/config.xml <<EOF
<domain type='lxc'>
  <name>$name</name>
  <memory unit='KiB'>$ram</memory>
  <currentMemory unit='KiB'>$ram</currentMemory>
  <vcpu placement='static'>4</vcpu>
  <cputune>
    <shares>921</shares>
  </cputune>
  <resource>
    <partition>/machine</partition>
  </resource>
  <os>
    <type arch='x86_64'>exe</type>
    <init>/sbin/init</init>
  </os>
  <clock offset='utc'/>
  <on_poweroff>destroy</on_poweroff>
  <on_reboot>restart</on_reboot>
  <on_crash>destroy</on_crash>
  <devices>
    <emulator>/opt/libvirt/libexec/libvirt_lxc</emulator>
    <filesystem type='mount' accessmode='passthrough'>
      <source dir='/var/lib/lxc/$name/rootfs'/>
      <target dir='/'/>
    </filesystem>
    <interface type='bridge'>
      <mac address='$mac'/>
      <source bridge='br-ex'/>
      <virtualport type='openvswitch'>
      </virtualport>
    </interface>
    <console type='pty'>
    </console>
  </devices>
</domain>
EOF

virsh define /var/lib/lxc/$name/config.xml
